<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>çœŸå¯¦äº¤æ˜“æ‰€å¯¦æ™‚è¡Œæƒ…</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #log {
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: .5rem;
      background: #fafafa;
    }
    #log div { margin-bottom: .3rem; }
    .time { color: #888; }
    .price { font-weight: bold; }
    .info { color: #007bff; }
    .error { color: #d9534f; }
    .warn { color: #f0ad4e; }
  </style>
</head>
<body>
  <h1>Binance BTC/USDT å¯¦æ™‚æˆäº¤</h1>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function appendLog(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      logEl.appendChild(div);
      div.scrollIntoView();
    }

    // å»ºç«‹ WebSocket é€£ç·š
    const socket = new WebSocket('ws://localhost:8080');

    // ç¢ºä¿ binary frame ä»¥ Blob æ¥æ”¶
    socket.binaryType = 'blob';

    socket.addEventListener('open', () => {
      appendLog('<span class="info">âœ… å·²é€£ç·šåˆ°æœ¬åœ° Relay Server</span>');
    });

    socket.addEventListener('error', e => {
      appendLog('<span class="error">âš ï¸ é€£ç·šéŒ¯èª¤ï¼Œè©³è¦‹ console</span>');
      console.error('WebSocket error:', e);
    });

    socket.addEventListener('close', e => {
      appendLog(`<span class="warn">ğŸ”Œ å·²æ–·ç·š (code=${e.code})</span>`);
    });

    socket.addEventListener('message', async e => {
      let raw;
      // å¦‚æœæ”¶åˆ° Blobï¼Œè¦å…ˆè½‰æˆæ–‡å­—
      if (e.data instanceof Blob) {
        raw = await e.data.text();
      } else {
        raw = e.data;
      }

      let msg;
      try {
        msg = JSON.parse(raw);
      } catch {
        return appendLog(`â“ ç„¡æ³•è§£æ JSONï¼š${raw}`);
      }

      // è™•ç† Binance trade è¨Šæ¯
      if (msg.e === 'trade') {
        const time = new Date(msg.E).toLocaleTimeString();
        appendLog(
          `<span class="time">[${time}]</span> ` +
          `<span class="price">æˆäº¤ ${msg.p} USDT Ã— ${msg.q}</span>`
        );
      }
      // è™•ç†è‡ªè¨‚ info è¨Šæ¯
      else if (msg.type === 'info') {
        appendLog(`<span class="info">â„¹ï¸ ${msg.data}</span>`);
      }
      // å…¶ä»–è¨Šæ¯
      else {
        appendLog('ğŸ”” å…¶ä»–è¨Šæ¯ï¼š' + JSON.stringify(msg));
      }
    });
  </script>
</body>
</html>
