<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>真實交易所實時行情</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #log {
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: .5rem;
      background: #fafafa;
    }
    #log div { margin-bottom: .3rem; }
    .time { color: #888; }
    .price { font-weight: bold; }
    .info { color: #007bff; }
    .error { color: #d9534f; }
    .warn { color: #f0ad4e; }
  </style>
</head>
<body>
  <h1>Binance BTC/USDT 實時成交</h1>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function appendLog(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      logEl.appendChild(div);
      div.scrollIntoView();
    }

    // 建立 WebSocket 連線
    const socket = new WebSocket('ws://localhost:8080');

    // 確保 binary frame 以 Blob 接收
    socket.binaryType = 'blob';

    socket.addEventListener('open', () => {
      appendLog('<span class="info">✅ 已連線到本地 Relay Server</span>');
    });

    socket.addEventListener('error', e => {
      appendLog('<span class="error">⚠️ 連線錯誤，詳見 console</span>');
      console.error('WebSocket error:', e);
    });

    socket.addEventListener('close', e => {
      appendLog(`<span class="warn">🔌 已斷線 (code=${e.code})</span>`);
    });

    socket.addEventListener('message', async e => {
      let raw;
      // 如果收到 Blob，要先轉成文字
      if (e.data instanceof Blob) {
        raw = await e.data.text();
      } else {
        raw = e.data;
      }

      let msg;
      try {
        msg = JSON.parse(raw);
      } catch {
        return appendLog(`❓ 無法解析 JSON：${raw}`);
      }

      // 處理 Binance trade 訊息
      if (msg.e === 'trade') {
        const time = new Date(msg.E).toLocaleTimeString();
        appendLog(
          `<span class="time">[${time}]</span> ` +
          `<span class="price">成交 ${msg.p} USDT × ${msg.q}</span>`
        );
      }
      // 處理自訂 info 訊息
      else if (msg.type === 'info') {
        appendLog(`<span class="info">ℹ️ ${msg.data}</span>`);
      }
      // 其他訊息
      else {
        appendLog('🔔 其他訊息：' + JSON.stringify(msg));
      }
    });
  </script>
</body>
</html>
